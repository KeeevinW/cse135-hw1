<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fingerprint Extra Credit</title>
</head>
<body>
    <h1>Fingerprinting Demo</h1>
    <p>This demo uses browser attributes (fonts, screen size, etc.) to identify you even if you delete cookies.</p>

    <hr>

    <div class="step-box">
        <h3>Your Identity</h3>
        <p><strong>Fingerprint Hash:</strong> <span id="fp-hash" style="color:blue; font-family: monospace;">Calculating...</span></p>
        <p><strong>Server Session Data:</strong> <span id="server-data" style="font-weight: bold;">Loading...</span></p>
    </div>

    <div class="step-box">
        <h3>Save Data (State)</h3>
        <input type="text" id="user-input" placeholder="Enter your name or secret">
        <button onclick="saveData()">Save to Server</button>
    </div>

    <div class="step-box" style="border-left: 5px">
        <h3>Test It</h3>
        
        <p><strong>Step A:</strong> Delete the session cookie. The browser now "forgets" who you are via standard methods.</p>
        <button onclick="deleteCookiesOnly()">Delete Cookies Only</button>
        <span id="cookie-status" style="color: green; margin-left: 10px;"></span>

        <br><br>

        <p><strong>Step B:</strong> Reload the page. The data will reappear because the fingerprint remains the same.</p>
        <button onclick="window.location.reload()">Reload Page</button>
    </div>

    <script>
      // Initialize the agent at application startup.
      const fpPromise = import('https://openfpcdn.io/fingerprintjs/v4')
        .then(FingerprintJS => FingerprintJS.load())

      // Get the visitor identifier when you need it.
      fpPromise
        .then(fp => fp.get())
        .then(result => {
          const visitorId = result.visitorId
          document.getElementById('fp-hash').textContent = visitorId;
          
          // Check in with the server using this ID
          checkServer(visitorId);
        })

      function checkServer(visitorId) {
          fetch('/cgi-bin/fingerprint-handler.php', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ action: 'check', fp: visitorId })
          })
          .then(res => res.json())
          .then(data => {
              document.getElementById('server-data').textContent = data.savedData || "No data saved for this fingerprint yet.";
              if(data.savedData) {
                  document.getElementById('user-input').value = data.savedData;
              }
          })
          .catch(err => console.error("Server Error:", err));
      }

      function saveData() {
          const val = document.getElementById('user-input').value;
          const visitorId = document.getElementById('fp-hash').textContent;

          fetch('/cgi-bin/fingerprint-handler.php', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ action: 'save', fp: visitorId, data: val })
          })
          .then(res => res.json())
          .then(data => {
              alert("Data saved linked to fingerprint!");
              document.getElementById('server-data').textContent = val;
          });
      }

      function deleteCookiesOnly() {
          document.cookie.split(";").forEach(function(c) { 
            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
          });
          
          alert("Cookies deleted! \n\nThe browser has now lost the session cookie.\nClick 'Reload' to see if the Fingerprint restores the data.");
          
          document.getElementById('cookie-status').textContent = "Cookies deleted! Ready to reload.";
      }
    </script>
</body>
</html>